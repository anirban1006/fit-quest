<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness & Nutrition Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; color: white; margin-bottom: 30px; }
        h1 { font-size: 2.5em; margin-bottom: 10px; }
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 30px; }
        .tab-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .stat-card h3 { color: #667eea; font-size: 0.85em; text-transform: uppercase; margin-bottom: 10px; }
        .stat-value { font-size: 2em; font-weight: bold; }
        .stat-label { font-size: 0.8em; color: #666; margin-top: 5px; }
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .card h2 { color: #667eea; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .list { max-height: 400px; overflow-y: auto; }
        .list-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .item-info { flex: 1; }
        .item-title { font-weight: bold; color: #667eea; margin-bottom: 5px; }
        .item-details { font-size: 0.9em; color: #666; }
        .delete-btn { background: #ff4757; padding: 8px 15px; width: auto; margin: 0; }
        .progress-bar { background: #e0e0e0; height: 10px; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .progress-fill { background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; transition: width 0.3s; }
        .macros { display: flex; justify-content: space-around; margin-top: 15px; padding-top: 15px; border-top: 2px solid #e0e0e0; }
        .macro-item { text-align: center; }
        .macro-value { font-size: 1.5em; font-weight: bold; color: #667eea; }
        .macro-label { font-size: 0.8em; color: #666; text-transform: uppercase; }
        .calorie-tracker { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); margin-bottom: 30px; }
        .calorie-display { text-align: center; margin-bottom: 20px; }
        .calorie-main { font-size: 3em; font-weight: bold; color: #667eea; }
        .calorie-remaining { font-size: 1.2em; color: #666; margin-top: 10px; }
        .calorie-goal-input { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
        .loading { text-align: center; padding: 20px; color: #999; }
        .error { background: #ff4757; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        @media (max-width: 768px) {
            .main-content { grid-template-columns: 1fr; }
            .dashboard { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ’ª Fitness & Nutrition Tracker</h1>
            <p>Track your workouts, meals, and achieve your goals</p>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-tab="nutrition">Nutrition</button>
            <button class="tab-btn" data-tab="workouts">Workouts</button>
            <button class="tab-btn" data-tab="goals">Goals</button>
        </div>

        <div id="error-message" class="error" style="display: none;"></div>

        <div id="nutrition-tab" class="tab-content active">
            <div class="calorie-tracker">
                <h2 style="color: #667eea; text-align: center; margin-bottom: 20px;">Today's Calories</h2>
                <div class="calorie-goal-input">
                    <input type="number" id="dailyCalorieGoal" placeholder="Daily goal (e.g., 2000)" min="0">
                    <button id="setGoalBtn" style="width: auto; padding: 10px 20px; margin: 0;">Set Goal</button>
                </div>
                <div class="calorie-display">
                    <div class="calorie-main" id="caloriesConsumed">0</div>
                    <div class="calorie-remaining" id="caloriesRemaining">Set a daily goal</div>
                    <div class="progress-bar" style="max-width: 600px; margin: 20px auto;">
                        <div class="progress-fill" id="calorieProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="macros">
                    <div class="macro-item"><div class="macro-value" id="totalProtein">0g</div><div class="macro-label">Protein</div></div>
                    <div class="macro-item"><div class="macro-value" id="totalCarbs">0g</div><div class="macro-label">Carbs</div></div>
                    <div class="macro-item"><div class="macro-value" id="totalFats">0g</div><div class="macro-label">Fats</div></div>
                </div>
            </div>

            <div class="main-content">
                <div class="card">
                    <h2>Add Meal</h2>
                    <form id="mealForm">
                        <div class="form-group"><label for="mealDate">Date</label><input type="date" id="mealDate" required></div>
                        <div class="form-group"><label for="mealType">Meal Type</label><select id="mealType" required><option value="Breakfast">Breakfast</option><option value="Lunch">Lunch</option><option value="Dinner">Dinner</option><option value="Snack">Snack</option></select></div>
                        <div class="form-group"><label for="foodName">Food/Dish Name</label><input type="text" id="foodName" required placeholder="e.g., Chicken Salad"></div>
                        <div class="form-group"><label for="mealCalories">Calories</label><input type="number" id="mealCalories" required min="0"></div>
                        <div class="form-row">
                            <div class="form-group"><label for="protein">Protein (g)</label><input type="number" id="protein" min="0" value="0"></div>
                            <div class="form-group"><label for="carbs">Carbs (g)</label><input type="number" id="carbs" min="0" value="0"></div>
                        </div>
                        <div class="form-group"><label for="fats">Fats (g)</label><input type="number" id="fats" min="0" value="0"></div>
                        <div class="form-group"><label for="mealNotes">Notes (optional)</label><textarea id="mealNotes" rows="2"></textarea></div>
                        <button type="submit">Add Meal</button>
                    </form>
                </div>
                <div class="card">
                    <h2>Today's Meals</h2>
                    <div class="list" id="mealList"><div class="loading">Loading meals...</div></div>
                </div>
            </div>
        </div>

        <div id="workouts-tab" class="tab-content">
            <div class="dashboard">
                <div class="stat-card"><h3>Total Workouts</h3><div class="stat-value" id="totalWorkouts">0</div></div>
                <div class="stat-card"><h3>Calories Burned</h3><div class="stat-value" id="totalCaloriesBurned">0</div></div>
                <div class="stat-card"><h3>Total Minutes</h3><div class="stat-value" id="totalDuration">0</div></div>
                <div class="stat-card"><h3>Net Calories</h3><div class="stat-value" id="netCalories">0</div><div class="stat-label">Consumed - Burned</div></div>
            </div>
            <div class="main-content">
                <div class="card">
                    <h2>Add Workout</h2>
                    <form id="workoutForm">
                        <div class="form-group"><label for="workoutDate">Date</label><input type="date" id="workoutDate" required></div>
                        <div class="form-group"><label for="workoutType">Type</label><select id="workoutType" required><option value="Running">Running</option><option value="Cycling">Cycling</option><option value="Swimming">Swimming</option><option value="Gym">Gym</option><option value="Yoga">Yoga</option><option value="Walking">Walking</option><option value="Other">Other</option></select></div>
                        <div class="form-group"><label for="duration">Duration (minutes)</label><input type="number" id="duration" required min="1"></div>
                        <div class="form-group"><label for="calories">Calories Burned</label><input type="number" id="calories" required min="0"></div>
                        <div class="form-group"><label for="workoutNotes">Notes (optional)</label><textarea id="workoutNotes" rows="3"></textarea></div>
                        <button type="submit">Add Workout</button>
                    </form>
                </div>
                <div class="card">
                    <h2>Recent Workouts</h2>
                    <div class="list" id="workoutList"><div class="loading">Loading workouts...</div></div>
                </div>
            </div>
        </div>

        <div id="goals-tab" class="tab-content">
            <div class="main-content">
                <div class="card">
                    <h2>Set Goal</h2>
                    <form id="goalForm">
                        <div class="form-group"><label for="goalType">Goal Type</label><select id="goalType" required><option value="Total Workouts">Total Workouts</option><option value="Total Calories Burned">Calories Burned</option><option value="Total Duration">Total Duration (mins)</option></select></div>
                        <div class="form-group"><label for="targetValue">Target Value</label><input type="number" id="targetValue" required min="1"></div>
                        <div class="form-group"><label for="deadline">Deadline (optional)</label><input type="date" id="deadline"></div>
                        <button type="submit">Set Goal</button>
                    </form>
                </div>
                <div class="card">
                    <h2>Your Goals</h2>
                    <div class="list" id="goalList"><div class="loading">Loading goals...</div></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- KEY FIX: Wait for the HTML document to be fully loaded before running any JavaScript ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- Application State and Constants ---
            const API_URL = 'http://127.0.0.1:5000/api';
            // A more reliable way to get today's date in YYYY-MM-DD format
            const currentDate = new Date().toLocaleDateString('en-CA');

            // --- Utility Functions ---
            function showError(message) {
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = `Error: ${message}. Please try again.`;
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 5000);
            }

            // --- Event Listeners Setup ---
            
            // Tab switching logic
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(`${tab}-tab`).classList.add('active');
                });
            });

            // Form submissions
            document.getElementById('setGoalBtn').addEventListener('click', handleSetCalorieGoal);
            document.getElementById('mealForm').addEventListener('submit', handleAddMeal);
            document.getElementById('workoutForm').addEventListener('submit', handleAddWorkout);
            document.getElementById('goalForm').addEventListener('submit', handleAddGoal);
            
            // Set default dates for input fields
            document.getElementById('mealDate').value = currentDate;
            document.getElementById('workoutDate').value = currentDate;
            
            // Initial data load
            fetchAllData();
            
            
            // --- API Data Fetching Functions ---
            async function fetchAllData() {
                await Promise.all([
                    fetchDailyMeals(),
                    fetchStats(),
                    fetchWorkouts(),
                    fetchGoals()
                ]).catch(err => showError('Could not load initial application data.'));
            }
            
            async function fetchDailyMeals() {
                try {
                    const [mealsRes, goalRes] = await Promise.all([
                        fetch(`${API_URL}/meals/daily/${currentDate}`),
                        fetch(`${API_URL}/calorie-goals/${currentDate}`)
                    ]);
                    
                    if (!mealsRes.ok || !goalRes.ok) throw new Error('Network response was not ok.');
                    
                    const data = await mealsRes.json();
                    const goalData = await goalRes.json();
                    renderDailyNutrition(data, goalData);
                } catch (error) {
                    showError('Failed to load daily meals');
                }
            }

            async function fetchStats() {
                try {
                    const response = await fetch(`${API_URL}/stats`);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const stats = await response.json();
                    renderStats(stats);
                } catch (error) {
                    showError('Failed to load statistics');
                }
            }

            async function fetchWorkouts() {
                try {
                    const response = await fetch(`${API_URL}/workouts`);
                    if (!response.ok) throw new Error('Network response was not ok.');
                    const workouts = await response.json();
                    renderWorkouts(workouts);
                } catch (error) {
                    showError('Failed to load workouts');
                }
            }

            async function fetchGoals() {
                try {
                    const [goalsRes, statsRes] = await Promise.all([
                        fetch(`${API_URL}/goals`),
                        fetch(`${API_URL}/stats`)
                    ]);

                    if (!goalsRes.ok || !statsRes.ok) throw new Error('Network response was not ok.');
                    
                    const goals = await goalsRes.json();
                    const stats = await statsRes.json();
                    renderGoals(goals, stats);
                } catch (error) {
                    showError('Failed to load goals');
                }
            }

            // --- Form Submission Handlers ---
            async function handleSetCalorieGoal() {
                const goalInput = document.getElementById('dailyCalorieGoal');
                const goal = parseInt(goalInput.value);
                if (!goal || goal <= 0) {
                    showError('Please enter a valid calorie goal');
                    return;
                }
                try {
                    await fetch(`${API_URL}/calorie-goals`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ date: currentDate, daily_goal: goal })
                    });
                    fetchDailyMeals();
                } catch (error) {
                    showError('Failed to set calorie goal');
                }
            }

            async function handleAddMeal(e) {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button[type="submit"]');
                
                const meal = {
                    date: form.elements.mealDate.value,
                    meal_type: form.elements.mealType.value,
                    food_name: form.elements.foodName.value,
                    calories: parseInt(form.elements.mealCalories.value),
                    protein: parseInt(form.elements.protein.value),
                    carbs: parseInt(form.elements.carbs.value),
                    fats: parseInt(form.elements.fats.value),
                    notes: form.elements.mealNotes.value
                };

                button.disabled = true;
                button.textContent = 'Adding...';

                try {
                    const response = await fetch(`${API_URL}/meals`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(meal)
                    });
                    if (!response.ok) throw new Error('Failed to add meal to the server.');
                    form.reset();
                    form.elements.mealDate.value = currentDate;
                    fetchDailyMeals();
                    fetchStats();
                } catch (error) {
                    showError('Failed to add meal');
                } finally {
                    button.disabled = false;
                    button.textContent = 'Add Meal';
                }
            }

            async function handleAddWorkout(e) {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button[type="submit"]');

                const workout = {
                    date: form.elements.workoutDate.value,
                    type: form.elements.workoutType.value,
                    duration: parseInt(form.elements.duration.value),
                    calories: parseInt(form.elements.calories.value),
                    notes: form.elements.workoutNotes.value
                };

                button.disabled = true;
                button.textContent = 'Adding...';

                try {
                    const response = await fetch(`${API_URL}/workouts`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(workout)
                    });
                    if (!response.ok) throw new Error('Failed to add workout to the server.');
                    form.reset();
                    form.elements.workoutDate.value = currentDate;
                    fetchWorkouts();
                    fetchStats();
                    fetchGoals();
                } catch (error) {
                    showError('Failed to add workout');
                } finally {
                    button.disabled = false;
                    button.textContent = 'Add Workout';
                }
            }

            async function handleAddGoal(e) {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button[type="submit"]');

                const goal = {
                    goal_type: form.elements.goalType.value,
                    target_value: parseInt(form.elements.targetValue.value),
                    deadline: form.elements.deadline.value || null
                };

                button.disabled = true;
                button.textContent = 'Setting...';

                try {
                    const response = await fetch(`${API_URL}/goals`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(goal)
                    });
                     if (!response.ok) throw new Error('Failed to add goal to the server.');
                    form.reset();
                    fetchGoals();
                } catch (error) {
                    showError('Failed to add goal');
                } finally {
                    button.disabled = false;
                    button.textContent = 'Set Goal';
                }
            }

            // --- Deletion Handlers ---
            window.deleteMeal = async function(id) {
                if (!confirm('Are you sure you want to delete this meal?')) return;
                try {
                    await fetch(`${API_URL}/meals/${id}`, { method: 'DELETE' });
                    fetchDailyMeals();
                    fetchStats();
                } catch (error) {
                    showError('Failed to delete meal');
                }
            }

            window.deleteWorkout = async function(id) {
                if (!confirm('Are you sure you want to delete this workout?')) return;
                try {
                    await fetch(`${API_URL}/workouts/${id}`, { method: 'DELETE' });
                    fetchWorkouts();
                    fetchStats();
                    fetchGoals();
                } catch (error) {
                    showError('Failed to delete workout');
                }
            }

            window.deleteGoal = async function(id) {
                if (!confirm('Are you sure you want to delete this goal?')) return;
                try {
                    await fetch(`${API_URL}/goals/${id}`, { method: 'DELETE' });
                    fetchGoals();
                } catch (error) {
                    showError('Failed to delete goal');
                }
            }

            // --- Rendering Functions ---
            function renderDailyNutrition(data, goalData) {
                const dailyGoal = goalData?.daily_goal || 0;
                document.getElementById('caloriesConsumed').textContent = data.totals.calories;
                const remaining = Math.max(0, dailyGoal - data.totals.calories);
                document.getElementById('caloriesRemaining').textContent = 
                    dailyGoal > 0 ? `of ${dailyGoal} kcal goal (${remaining} remaining)` : 'Set a daily goal';
                
                document.getElementById('totalProtein').textContent = `${data.totals.protein}g`;
                document.getElementById('totalCarbs').textContent = `${data.totals.carbs}g`;
                document.getElementById('totalFats').textContent = `${data.totals.fats}g`;
                
                const progress = dailyGoal > 0 ? Math.min((data.totals.calories / dailyGoal) * 100, 100) : 0;
                document.getElementById('calorieProgress').style.width = `${progress}%`;

                const mealList = document.getElementById('mealList');
                if (data.meals.length === 0) {
                    mealList.innerHTML = '<p class="loading">No meals logged for today</p>';
                } else {
                    mealList.innerHTML = data.meals.map(m => `
                        <div class="list-item">
                            <div class="item-info">
                                <div class="item-title">${m.meal_type}: ${m.food_name}</div>
                                <div class="item-details">
                                    ${m.calories} kcal | P: ${m.protein}g | C: ${m.carbs}g | F: ${m.fats}g
                                    ${m.notes ? `<br><em>${m.notes}</em>` : ''}
                                </div>
                            </div>
                            <button class="delete-btn" onclick="deleteMeal(${m.id})">Delete</button>
                        </div>
                    `).join('');
                }
            }

            function renderStats(stats) {
                document.getElementById('totalWorkouts').textContent = stats.total_workouts;
                document.getElementById('totalCaloriesBurned').textContent = stats.total_calories_burned;
                document.getElementById('totalDuration').textContent = stats.total_duration;
                document.getElementById('netCalories').textContent = stats.net_calories;
            }

            function renderWorkouts(workouts) {
                const workoutList = document.getElementById('workoutList');
                if (workouts.length === 0) {
                    workoutList.innerHTML = '<p class="loading">No workouts logged yet</p>';
                } else {
                    workoutList.innerHTML = workouts.map(w => {
                        const workoutDate = new Date(w.date + 'T00:00:00').toLocaleDateString();
                        return `
                        <div class="list-item">
                            <div class="item-info">
                                <div class="item-title">${w.type}</div>
                                <div class="item-details">
                                    ${workoutDate} â€¢ ${w.duration} mins â€¢ ${w.calories} kcal burned
                                    ${w.notes ? `<br><em>${w.notes}</em>` : ''}
                                </div>
                            </div>
                            <button class="delete-btn" onclick="deleteWorkout(${w.id})">Delete</button>
                        </div>
                    `}).join('');
                }
            }

            function renderGoals(goals, stats) {
                const goalList = document.getElementById('goalList');
                if (goals.length === 0) {
                    goalList.innerHTML = '<p class="loading">No goals set yet. Add one!</p>';
                } else {
                    goalList.innerHTML = goals.map(g => {
                        let current = 0;
                        if (g.goal_type === 'Total Workouts') current = stats.total_workouts;
                        else if (g.goal_type === 'Total Calories Burned') current = stats.total_calories_burned;
                        else if (g.goal_type === 'Total Duration') current = stats.total_duration;
                        
                        const progress = g.target_value > 0 ? Math.min((current / g.target_value) * 100, 100) : 0;
                        const completed = current >= g.target_value;
                        
                        return `
                            <div class="list-item">
                                <div class="item-info">
                                    <div class="item-title">${g.goal_type}</div>
                                    <div class="item-details">
                                        Target: ${g.target_value.toLocaleString()} | Current: ${current.toLocaleString()}
                                        ${g.deadline ? `<br>Deadline: ${new Date(g.deadline + 'T00:00:00').toLocaleDateString()}` : ''}
                                        ${completed ? '<br><strong style="color: #28a745;">âœ“ Goal Achieved!</strong>' : ''}
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                                <button class="delete-btn" onclick="deleteGoal(${g.id})">Delete</button>
                            </div>
                        `;
                    }).join('');
                }
            }
        }); // <-- End of the DOMContentLoaded listener
    </script>
</body>
</html>